---
title: "Defense vs Position"
subtitle: "2023 Season"
format:
  html:
      theme: cosmo
      df-print: paged
      self-contained: true
      toc: true
      fig-width: 8
      fig-height: 6
editor: visual
author: James Brown
echo: false
warning: false
message: false
---

```{r}
# Libraries and functions
library(tidyverse)
library(qreport)
library(kableExtra)
library(fitzRoy)

`%notin%` <- Negate(`%in%`)

# Load data processing functions
source("../../Functions/data_processing_functions.R")
```

```{r}
#| results: asis

# Get Data
current_season_data <- get_fantasy_data(season = Sys.Date() |> year())

# Get player positions from clustering algorithm
positions <-
 read_rds("../../Data/afl_clustering_positions.rds") |>
 mutate(round = paste("Round", round)) |>
 select(player_name, round, position, position_name)

# Join with position data
current_season_data <-
current_season_data |> 
  left_join(positions, by = c("player_full_name" = "player_name", "round" = "round"))

# Make round number an ordered factor
current_season_data$round <-
  factor(
    current_season_data$round,
    levels = c(
      'Round 1',
      'Round 2',
      'Round 3',
      'Round 4',
      'Round 5',
      'Round 6',
      'Round 7',
      'Round 8',
      'Round 9',
      'Round 10',
      'Round 11',
      'Round 12',
      'Round 13',
      'Round 14',
      'Round 15',
      'Round 16',
      'Round 17',
      'Round 18',
      'Round 19',
      'Round 20',
      'Round 21',
      'Round 22',
      'Round 23',
      'Round 24',
      'Finals Week 1',
      'Semi Finals',
      'Preliminary Finals',
      'Grand Final'
    ),
    ordered = TRUE
  )
```

```{r}

# Get list of opposition teams
team_list <-
current_season_data |>
  distinct(opposition_team) |> 
  pull(opposition_team)

# Get list of positions
position_list <-
current_season_data |>
  distinct(position_name) |>
  filter(!is.na(position_name)) |> 
  pull(position_name)

# Function to get difference between average vs all other teams vs score vs team
get_dvp <- function(opp_team, pos, n_rounds) {
  
  # Get last n rounds data
  rounds_list <-
  current_season_data |>
  distinct(round) |>
  arrange(desc(round)) |>
  slice_head(n = n_rounds)

  # Get positional dataset
  data <-
    current_season_data |>
    filter(round %in% rounds_list$round) |>
    filter(position_name == pos)
  
  # Avg vs all other sides
  vs_others <-
    data |>
    filter(opposition_team != opp_team) |>
    summarise(avg_vs_others = mean(fantasy_points, na.rm = TRUE), .by = player_full_name)
  
  # Avg vs side
  vs_team <-
    data |>
    filter(opposition_team == opp_team) |>
    summarise(avg_vs_team = mean(fantasy_points, na.rm = TRUE), .by = player_full_name)
  
  # Join together
  all_data <-
  inner_join(vs_others, vs_team)
  
  # Get dvp score
  score = mean(all_data$avg_vs_team) - mean(all_data$avg_vs_others)
  score = round(score, 2)

  # Get percentage scoring over their avg vs team_list
  percentage = mean(all_data$avg_vs_team > all_data$avg_vs_others)
  percentage = round(percentage * 100, 2)
  
  tibble(opposition_team = opp_team, dvp = score, percentage_over_avg = percentage)
}

```

```{r}
# Create df of all combinations
dvp_data <-
    expand_grid(opp_team = team_list,
     pos = position_list,
      n_rounds = c(5, 10, 15))

# Apply function to each combination of the dataframe columns
dvp_output <-
 pmap_df(.l = dvp_data, .f = get_dvp) |>
 cbind(dvp_data[,-1])

 # Separate into 5, 10, 15 round dataframes----------------

dvp_output_5 <-
  dvp_output |>
  filter(n_rounds == 5) |>
  arrange(desc(dvp))

dvp_output_10 <-
  dvp_output |>
  filter(n_rounds == 10) |>
  arrange(desc(dvp))

dvp_output_15 <-
  dvp_output |>
  filter(n_rounds == 15) |>
  arrange(desc(dvp))
```

## DVP Disposals

```{r}
# Function to get difference between average vs all other teams vs score vs team
get_dvp_disposals <- function(opp_team, pos, n_rounds) {
  
  # Get last n rounds data
  rounds_list <-
  current_season_data |>
  distinct(round) |>
  arrange(desc(round)) |>
  slice_head(n = n_rounds)

  # Get positional dataset
  data <-
    current_season_data |>
    filter(round %in% rounds_list$round) |>
    filter(position_name == pos)
  
  # Avg vs all other sides
  vs_others <-
    data |>
    filter(opposition_team != opp_team) |>
    summarise(avg_vs_others = mean(disposals, na.rm = TRUE), .by = player_full_name)
  
  # Avg vs side
  vs_team <-
    data |>
    filter(opposition_team == opp_team) |>
    summarise(avg_vs_team = mean(disposals, na.rm = TRUE), .by = player_full_name)
  
  # Join together
  all_data <-
  inner_join(vs_others, vs_team)
  
  # Get dvp score
  score = mean(all_data$avg_vs_team) - mean(all_data$avg_vs_others)
  score = round(score, 2)

  # Get percentage scoring over their avg vs team_list
  percentage = mean(all_data$avg_vs_team > all_data$avg_vs_others)
  percentage = round(percentage * 100, 2)
  
  tibble(opposition_team = opp_team, dvp = score, percentage_over_avg = percentage)
}
```

```{r}
# Apply function to each combination of the dataframe columns
dvp_output_disposals <-
 pmap_df(.l = dvp_data, .f = get_dvp_disposals) |>
 cbind(dvp_data[,-1])

 # Separate into 5, 10, 15 round dataframes----------------

dvp_output_disposals_5 <-
  dvp_output_disposals |>
  filter(n_rounds == 5) |>
  arrange(desc(dvp))

dvp_output_disposals_10 <-
  dvp_output_disposals |>
  filter(n_rounds == 10) |>
  arrange(desc(dvp))

dvp_output_disposals_15 <-
  dvp_output_disposals |>
  filter(n_rounds == 15) |>
  arrange(desc(dvp))
```

## Last 10 Rounds

```{r}
# Disposals
pos_list <-
 map(position_list,
  ~ dvp_output_disposals_10 |> filter(pos == .x) |>
  kbl() |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")))

names(pos_list) <- position_list

# Fantasy
pos_list_fantasy <-
 map(position_list,
  ~ dvp_output_10 |> filter(pos == .x) |>
  kbl() |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")))

names(pos_list_fantasy) <- position_list
```

## DVP Disposals

```{r}
#| results: asis
#| rows.print: 18

# Create tabsets
maketabs(pos_list, wide = TRUE)
```

## DVP Fantasy Points

```{r}
#| results: asis
#| rows.print: 18

# Create tabsets
maketabs(pos_list_fantasy, wide = TRUE)
```