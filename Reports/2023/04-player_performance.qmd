---
title: "Player Performance"
format:
  html:
      theme: cosmo
      page-layout: full
      df-print: paged
      self-contained: true
      toc: true
      fig-width: 8
      fig-height: 6
editor: visual
author: James Brown
echo: false
warning: false
message: false
---

```{r}
#===============================================================================
# Libraries and functions
#===============================================================================

library(tidyverse)
library(qreport)
library(ggplot2)
`%notin%` <- Negate(`%in%`)

#===============================================================================
# Read in data
#===============================================================================

# Get helper functions
source("../../Functions/data_processing_functions.r")

# Get data
data_2023 <- get_fantasy_data(season = 2023)
afl_fantasy_2014_2022_data <- readRDS("../../Data/afl_fantasy_2014_2022_data.rds")

# Combine
afl_fantasy_data <-
  bind_rows(data_2023, afl_fantasy_2014_2022_data) |> 
  arrange(start_time_utc)

# Make round number an ordered factor
afl_fantasy_data$round <-
  factor(
    afl_fantasy_data$round,
    levels = c(
      'Round 1',
      'Round 2',
      'Round 3',
      'Round 4',
      'Round 5',
      'Round 6',
      'Round 7',
      'Round 8',
      'Round 9',
      'Round 10',
      'Round 11',
      'Round 12',
      'Round 13',
      'Round 14',
      'Round 15',
      'Round 16',
      'Round 17',
      'Round 18',
      'Round 19',
      'Round 20',
      'Round 21',
      'Round 22',
      'Round 23',
      'Round 24',
      'Finals Week 1',
      'Semi Finals',
      'Preliminary Finals',
      'Grand Final'
    ),
    ordered = TRUE
  )

```

```{r}
# Get player history datasets
player_history <-
  afl_fantasy_data |>
  transmute(
    player_full_name,
    season = factor(season_name),
    round,
    start_time_utc,
    player_team = factor(player_team),
    opposition_team = factor(opposition_team),
    venue = factor(venue),
    match_result_string,
    disposals,
    fantasy_points,
    tog_percentage
  ) |> 
  arrange(player_full_name, desc(start_time_utc))

# Filter to only players who have played in 2023
player_history_2023 <-
  player_history |> 
  filter(player_full_name %in% data_2023$player_full_name)

```

```{r}
# Full season
player_averages_2023 <-
player_history_2023 |>
filter(season == "2023") |>
filter(tog_percentage >= 50) |>
group_by(player_full_name, player_team) |>
summarise(games = n(), avg_disposals = mean(disposals), avg_fantasy = mean(fantasy_points)) |>
arrange(desc(avg_fantasy))

# Last 3
player_averages_last_3 <-
player_history_2023 |>
filter(season == "2023") |>
filter(tog_percentage >= 50) |>
group_by(player_full_name, player_team) |>
arrange(desc(round)) |>
slice_head(n = 3) |>
summarise(games = n(), avg_disposals_last_3 = mean(disposals), avg_fantasy_last_3 = mean(fantasy_points)) |>
arrange(desc(avg_fantasy_last_3)) |>
filter(games == 3) |>
select(-games)

# Last 5
player_averages_last_5 <-
player_history_2023 |>
filter(season == "2023") |>
filter(tog_percentage >= 50) |>
group_by(player_full_name, player_team) |>
arrange(desc(round)) |>
slice_head(n = 5) |>
summarise(games = n(), avg_disposals_last_5 = mean(disposals), avg_fantasy_last_5 = mean(fantasy_points)) |>
arrange(desc(avg_fantasy_last_5)) |>
filter(games == 5) |>
select(-games)

# Last 7
player_averages_last_7 <-
player_history_2023 |>
filter(season == "2023") |>
filter(tog_percentage >= 50) |>
group_by(player_full_name, player_team) |>
arrange(desc(round)) |>
slice_head(n = 7) |>
summarise(games = n(), avg_disposals_last_7 = mean(disposals), avg_fantasy_last_7 = mean(fantasy_points)) |>
arrange(desc(avg_fantasy_last_7)) |>
filter(games == 7) |>
select(-games)

# Last 10
player_averages_last_10 <-
player_history_2023 |>
filter(season == "2023") |>
filter(tog_percentage >= 50) |>
group_by(player_full_name, player_team) |>
arrange(desc(round)) |>
slice_head(n = 10) |>
summarise(games = n(), avg_disposals_last_10 = mean(disposals), avg_fantasy_last_10 = mean(fantasy_points)) |>
arrange(desc(avg_fantasy_last_10)) |>
filter(games == 10) |>
select(-games)
```

# Top Players

## Disposals

```{r}
# Full season
player_averages_2023 |>
arrange(desc(avg_disposals)) |>
select(-avg_fantasy)

# Last 3
player_averages_last_3 |>
arrange(desc(avg_disposals_last_3)) |>
select(-avg_fantasy_last_3)
```

## Fantasy

```{r}

```

# Performing Above Average Recently

## Disposals

```{r}
#| results: asis
# Last 3
disposals_l3 <-
player_averages_2023 |>
left_join(player_averages_last_3) |>
select(-avg_fantasy, -avg_fantasy_last_3) |>
mutate(diff = avg_disposals_last_3 - avg_disposals) |>
arrange(desc(diff))

# Last 5
disposals_l5 <-
player_averages_2023 |>
left_join(player_averages_last_5) |>
select(-avg_fantasy, -avg_fantasy_last_5) |>
mutate(diff = avg_disposals_last_5 - avg_disposals) |>
arrange(desc(diff))

# Last 7
disposals_l7 <-
player_averages_2023 |>
left_join(player_averages_last_7) |>
select(-avg_fantasy, -avg_fantasy_last_7) |>
mutate(diff = avg_disposals_last_7 - avg_disposals) |>
arrange(desc(diff))

# Last 10
disposals_l10 <-
player_averages_2023 |>
left_join(player_averages_last_10) |>
select(-avg_fantasy, -avg_fantasy_last_10) |>
mutate(diff = avg_disposals_last_10 - avg_disposals) |>
arrange(desc(diff))

# Create tabset
disposals_list <-
list(
  "Last 3" = disposals_l3,
  "Last 5" = disposals_l5,
  "Last 7" = disposals_l7,
  "Last 10" = disposals_l10
)

# Round all numeric columns for each dataframe in the list
disposals_list <-
  disposals_list |>
  map(~ .x |>
        mutate_if(is.numeric, round, 1))

maketabs(disposals_list, wide = TRUE)
```

## Fantasy

```{r}
#| results: asis

# Last 3
fantasy_l3 <-
player_averages_2023 |>
left_join(player_averages_last_3) |>
select(-avg_disposals, -avg_disposals_last_3) |>
mutate(diff = avg_fantasy_last_3 - avg_fantasy) |>
arrange(desc(diff))

# Last 5
fantasy_l5 <-
player_averages_2023 |>
left_join(player_averages_last_5) |>
select(-avg_disposals, -avg_disposals_last_5) |>
mutate(diff = avg_fantasy_last_5 - avg_fantasy) |>
arrange(desc(diff))

# Last 7
fantasy_l7 <-
player_averages_2023 |>
left_join(player_averages_last_7) |>
select(-avg_disposals, -avg_disposals_last_7) |>
mutate(diff = avg_fantasy_last_7 - avg_fantasy) |>
arrange(desc(diff))

# Last 10
fantasy_l10 <-
player_averages_2023 |>
left_join(player_averages_last_10) |>
select(-avg_disposals, -avg_disposals_last_10) |>
mutate(diff = avg_fantasy_last_10 - avg_fantasy) |>
arrange(desc(diff))

# Create tabset
fantasy_list <-
list(
  "Last 3" = fantasy_l3,
  "Last 5" = fantasy_l5,
  "Last 7" = fantasy_l7,
  "Last 10" = fantasy_l10
)

# Round all numeric columns for each dataframe in the list
fantasy_list <-
  fantasy_list |>
  map(~ .x |>
        mutate_if(is.numeric, round, 1))

maketabs(fantasy_list, wide = TRUE)
```

# Players Performing Below Average Recently

## Disposals

```{r}
#| results: asis
disposals_list <-
  disposals_list |>
  map(~ .x |>
        arrange((diff)))

maketabs(disposals_list, wide = TRUE)
```

## Fantasy

```{r}
#| results: asis
fantasy_list <-
  fantasy_list |>
  map(~ .x |>
        arrange((diff)))

maketabs(fantasy_list, wide = TRUE)
```
